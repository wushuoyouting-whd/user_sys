## TypeORM Migration 使用指南

### 1. 何时需要手动生成 Migration

在以下情况下需要手动生成 Migration，建议在部署前生成并在生产环境执行：

- 修改了 `Entity` 结构后需要生成新的 migration
- 新增 `Entity` 时需要生成 migration
- 删除 `Entity` 字段或更改字段类型时需要生成 migration

### 2. Migration 运行时机

- **开发阶段**: 修改 `entities` 后，可以使用 `DB_SYNCHRONIZE=true` 自动同步（仅限开发环境）
- **生产环境**: 应该手动控制 migration 运行时机，确保数据安全
- **部署时**: 在应用启动前运行 `npx typeorm migration:run -d src/config/db.js`

### 3. 推荐工作流程

#### 开发阶段
保持 `DB_SYNCHRONIZE=true` 以提高开发效率

#### 发布准备阶段
1. 设置 `DB_SYNCHRONIZE=false`
2. 生成 migration:
   ```bash
   npx typeorm migration:generate src/migrations/xx命名 -d src/config/db.js
   ```

3. 运行 migration:
   ```bash
   npx typeorm migration:run -d src/config/db.js
   ```


#### 优势
- 保证开发效率的同时确保生产环境的数据安全
- 通过版本控制管理数据库结构变更
## Migration 回退操作

### 回退命令
```bash
# 执行 migration 回退
npx typeorm migration:revert -d src/config/db.js
```


### 回退原理

1. **执行 `down` 方法**: TypeORM 会执行 [UserInit1765293497188](file:///Users/wenhuadong/prj/user_sys/be/user_be_nodejs/src/migrations/1765293497188-UserInit.js#L8-L8) 类中的 `down` 方法
2. **逆向操作**: 按照 `down` 方法中定义的 SQL 语句进行逆向操作
3. **版本回滚**: 将数据库状态回滚到上一个 migration 版本

### 当前 Migration 的回退行为

根据 [1765293497188-UserInit.js](file:///Users/wenhuadong/prj/user_sys/be/user_be_nodejs/src/migrations/1765293497188-UserInit.js) 中的定义：

- **`up` 操作**:
    - 删除 `name` 列
    - 添加长度为 400 的 `name` 列

- **`down` 操作**:
    - 删除当前的 `name` 列
    - 添加长度为 100 的 `name` 列（恢复到之前的状态）

### 注意事项

⚠️ **数据丢失风险**: 由于涉及 DROP COLUMN 操作，回退可能导致该列数据丢失

✅ **建议**: 在生产环境执行回退前务必备份数据库